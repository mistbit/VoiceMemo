# 会议纪要能力技术方案（阿里云听悟离线转写 + OSS）— VoiceMemo

更新时间：2026-01-20  
适用项目：VoiceMemo（macOS）  
目标：将采集到的会议音频自动产出“会议纪要”（摘要/要点/行动项/按角色分段等），并提供可配置的端侧流程与结果留存。

## 1. 核心配置（已确认）

### 1.1 听悟接入信息
- **AppKey**: `YOUR_TINGWU_APPKEY`
- **AccessKeyId / Secret**: 
  - 用户手动输入
  - **安全存储**：macOS Keychain（禁止明文落盘/日志）
  - **展示**：掩码显示 (`******`)，提供“清除/重新输入”功能
- **语种模式**：
  - 中文 (cn)
  - 中英混说 (cn_en)（暂不开放 auto）
- **功能开关**：摘要、要点、行动项、结论、按角色分段（全选）

### 1.2 OSS 存储配置
- **Region**: `oss-cn-beijing` (华北2 北京)
- **Endpoint**: `https://oss-cn-beijing.aliyuncs.com` (强制 HTTPS)
- **Bucket**: `wechat-record`
- **Prefix**: `wvr/`
- **权限**: **公共读** (Public Read) - *MVP 验证阶段*
- **生命周期**: 365 天自动删除
- **ObjectKey 规则**: `wvr/{yyyy}/{MM}/{dd}/{recordingId}/mixed.m4a`
  - `recordingId` = 时间戳 + 随机串

### 1.3 音频形态
- **类型**: A (Mixed 单轨) - *MVP 阶段*
  - 后续可扩展为 B (单文件双轨)
- **规格**: 统一转码为 **m4a (AAC), 48kHz**
- **时长**: 支持长音频 (300分钟+)

## 2. 端到端架构（手动流水线）

采用 **Pipeline + State Machine** 架构，UI 上呈现为可手动触发的节点流程。

### 2.1 节点定义 (Nodes)

1.  **Recording (已录制)**
    - 输入：AudioRecorder 完成事件
    - 展示：文件路径、时长、大小
    - 动作：点击 "Start Processing" 进入下一步

2.  **Transcoding (转码中)**
    - 动作：调用 AVAssetExportSession
    - 目标：转为 48kHz AAC m4a
    - 允许重试

3.  **Uploading (上传中)**
    - 动作：调用 OSS PutObject
    - 输出：OSS Public URL
    - 允许重试

4.  **Creating Task (创建任务)**
    - 动作：调用听悟 `CreateTask` API
    - 输入：OSS URL, AppKey, Params
    - 输出：TaskId
    - 允许重试

5.  **Polling (轮询中)**
    - 动作：调用听悟 `GetTaskInfo` API
    - 策略：**手动触发** (UI 提供“刷新状态”按钮) + 建议的最小间隔限制 (e.g. 30s)
    - 状态：WAITING -> RUNNING -> SUCCEEDED / FAILED

6.  **Completed (完成)**
    - 动作：解析 JSON 结果，存入数据库
    - 展示：Markdown 预览，支持导出

### 2.2 数据模型 (SQLite)

使用 `SQLite.swift` 管理本地数据。

#### Table: `meeting_tasks`
| Field | Type | Note |
| :--- | :--- | :--- |
| `id` | TEXT (UUID) | Primary Key |
| `created_at` | DATETIME | |
| `recording_id` | TEXT | 关联录音文件的 ID |
| `local_file_path` | TEXT | 本地 mixed 文件路径 |
| `oss_url` | TEXT | 上传后的公网 URL |
| `tingwu_task_id` | TEXT | 听悟任务 ID |
| `status` | TEXT | enum: recorded, transcoding, uploading, created, polling, completed, failed |
| `title` | TEXT | 自动生成 (e.g. "Meeting 2026-01-20") |
| `raw_response` | TEXT | **保存** 原始 JSON (排障/兼容) |
| `transcript` | TEXT | 全文转写 |
| `summary` | TEXT | 摘要 |
| `key_points` | TEXT | 要点 (Markdown list) |
| `action_items` | TEXT | 行动项 (Markdown list) |

## 3. 实现计划

### 3.1 基础层
- **KeychainHelper**: 封装 Security framework，存取 `ak_id`, `ak_secret`。
- **DatabaseManager**: 封装 SQLite.swift，负责表创建与 CRUD。
- **SettingsStore**: ObservableObject，管理 UserDefaults (非敏感配置) 和 Keychain (敏感配置)。

### 3.2 云服务层
- **OSSService**:
  - 使用 `alibabacloud-oss-swift-sdk-v2`
  - 实现 `putObject`
- **TingwuService**:
  - **手动实现阿里云 V4 签名** (因无官方 Swift SDK)
  - HTTP Client (URLSession)
  - API: `CreateTask`, `GetTaskInfo`

### 3.3 业务层
- **MeetingPipelineManager**:
  - 维护当前 Task 状态
  - 暴露 `process()`, `upload()`, `createTask()`, `refreshStatus()` 方法
  - 发布 `Published` 状态供 UI 响应

### 3.4 UI 层
- **SettingsView**: AK/SK 输入 (SecureField), Test Connection 按钮。
- **PipelineView**: 垂直/水平 Stepper，显示当前步骤、Loading 状态、Retry 按钮。
- **ResultView**:
  - Markdown 渲染 (使用 SwiftUI Text 或 WebView)
  - 角色分段展示 (Scheme A: 纪要层分“我方/对方/行动项”)
  - 导出按钮 (Save to File)

## 4. 风险与规避
- **OSS 公开读**: MVP 阶段接受风险，依赖 ObjectKey 随机性 + 365天生命周期。
- **AK 泄露**: 严格限制在 Keychain，代码中不硬编码，日志中脱敏。
- **长音频**: 300分钟音频处理时间较长，UI 需支持“离开后回来查看” (通过 SQLite 持久化状态)。
